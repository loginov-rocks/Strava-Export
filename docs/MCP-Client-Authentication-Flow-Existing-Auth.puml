@startuml MCP Client Authentication Flow (Existing Auth)

participant User
participant "MCP Client" as MCP
participant "API Server" as API

User -> MCP: Connect to MCP Server
MCP -> API: GET /oauth/authorize\n(with client_id, redirect_uri, code_challenge, state)
API -> API: Check for existing auth cookies\n(valid cookies found!)
API -> API: Validate existing session
API -> API: Skip Strava - user already authenticated
API -> API: Generate OAuth authorization code\n(for MCP client)
API -> MCP: Redirect to MCP redirect_uri\n(with authorization code, state)
MCP -> API: POST /oauth/token\n(exchange auth code for tokens, PKCE)
API -> API: Validate PKCE code_verifier
API -> MCP: Return access_token, refresh_token
MCP -> User: Connection successful

note right of API
  No Strava interaction needed!
  Existing web app authentication
  enables seamless MCP connection
end note

@enduml
